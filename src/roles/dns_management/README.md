# DNS Management Role

This Ansible role manages DNS records for Mailu email domains. It currently supports Cloudflare as a DNS provider and handles the creation of all necessary DNS records for proper email delivery and authentication.

## Responsibilities

- Creating A records for mail, webmail, admin, and autoconfig subdomains
- Setting up MX records for mail routing
- Configuring SPF records for sender authentication
- Configuring DKIM records for email signing
- Configuring DMARC records for email authentication policy
- Generating DNS record documentation

## Requirements

- Access to a supported DNS provider (currently Cloudflare)
- API tokens with appropriate permissions
- Domain configurations from the domain_management role

## Role Variables

### Default Variables

```yaml
# Base directory for domain configurations
domain_config_dir: "{{ playbook_dir }}/../domains"

# Base directory for mail server
mailu_base_dir: "/opt/mailu"

# DNS records directory
dns_records_dir: "{{ mailu_base_dir }}/dns"

# Whether to generate debug output
dns_debug: false

# DNS provider (currently supported: cloudflare)
dns_provider: "cloudflare"

# DNS records to manage
manage_a_records: true
manage_mx_records: true
manage_spf_records: true
manage_dkim_records: true
manage_dmarc_records: true
manage_autoconfig_records: true

# Default SPF record value
default_spf_record: "v=spf1 mx -all"

# Default DMARC policy
default_dmarc_policy: "v=DMARC1; p=none; rua=mailto:postmaster@{{ domain }}"

# Whether to proxy web records through Cloudflare
proxy_web_records: true

# Whether to proxy mail records (should always be false)
proxy_mail_records: false
```

### Required Variables

- `vault_cloudflare_api_token`: API token for Cloudflare access
- `domain_dkim_keys`: Dictionary of DKIM keys generated by domain_management role

## Dependencies

- domain_management role

## Example Playbook

```yaml
- hosts: mail_servers
  roles:
    - role: domain_management
    - role: dns_management
      dns_provider: "cloudflare"
      proxy_web_records: true
```

## DNS Record Documentation

This role generates documentation about the DNS records it creates:

- Individual domain records are saved to: `{{ dns_records_dir }}/<domain>.dns`
- Combined records for all domains: `{{ dns_records_dir }}/all_domains.dns`

## Author Information

Created for the Mailu Multi-Domain Ansible project.