# DKIM signing configuration for Rspamd
# Generated by Ansible - Do not edit manually

allow_username_mismatch = true;
try_fallback = true;
use_domain = "header";
use_esld = true;
use_redis = false; # We use file-based keys
path = "/dkim/$domain.$selector.key";
selector_map = "/dkim/selectors.map";

# Domain-specific signing settings
{% for domain_item in loaded_domains.results %}
{% set domain_cfg = domain_item.ansible_facts.domain_config %}
domain {
    {{ domain_cfg.domain }} {
        path = "/dkim/{{ domain_cfg.domain }}.{{ dkim_selector }}.key";
        selector = "{{ dkim_selector }}";
        sign_headers = "from:sender:reply-to:subject:date:message-id:to:cc:mime-version:content-type:content-transfer-encoding:content-id:content-description:resent-date:resent-from:resent-sender:resent-to:resent-cc:resent-message-id:in-reply-to:references";
    }
}
{% endfor %}

sign_local = true;
sign_authenticated = true;
sign_inbound = false; # Don't sign inbound messages

# DKIM signature settings
headers_canon = "relaxed";
body_canon = "relaxed";
sign_algorithm = "{{ dkim_algorithm }}";

# Symbol settings
symbol_allow = "DKIM_ALLOW";
symbol_reject = "DKIM_REJECT";
symbol_tempfail = "DKIM_TEMPFAIL";
symbol_na = "DKIM_NA";