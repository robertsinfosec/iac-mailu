; DNS Configuration for domain: {{ domain }}
; Generated by Mailu Ansible playbook - {{ ansible_date_time.date }}
; -----------------------------------------------------------------

; A RECORDS
{{ domain_config.hostname }}.       IN  A     {{ server_ip }}
{{ domain_config.webmail }}.        IN  A     {{ server_ip }}
{{ domain_config.admin }}.          IN  A     {{ server_ip }}
autoconfig.{{ domain }}             IN  A     {{ server_ip }}
autodiscover.{{ domain }}           IN  A     {{ server_ip }}

; MX RECORDS
{{ domain }}                        IN  MX    {{ domain_config.dns.mx.priority | default('10') }} {{ domain_config.dns.mx.hostname | default(domain_config.hostname) }}
{% for mx_host in domain_config.dns.additional_mx_hosts | default([]) %}
{{ domain }}                        IN  MX    {{ mx_host.priority }} {{ mx_host.hostname }}
{% endfor %}

; SPF RECORD
{{ domain }}                        IN  TXT   "{{ domain_config.spf_record | default('v=spf1 mx a -all') }}"

; DKIM RECORD - Run "docker-compose exec admin cat /data/dkim/{{ domain }}.dkim.key" 
; to get the actual DKIM key if not using automated DNS management
dkim._domainkey.{{ domain }}        IN  TXT   "v=DKIM1; k=rsa; p={{ '{{ dkim_key }}' }}"

; DMARC RECORD
_dmarc.{{ domain }}                 IN  TXT   "v=DMARC1; p=quarantine; sp=quarantine; adkim=r; aspf=r; pct=100; fo=1; rua=mailto:postmaster@{{ domain }}; ruf=mailto:postmaster@{{ domain }};"

; SRV RECORDS FOR AUTODISCOVERY
_imap._tcp.{{ domain }}             IN  SRV   0 1 143 {{ domain_config.hostname }}.
_imaps._tcp.{{ domain }}            IN  SRV   0 1 993 {{ domain_config.hostname }}.
_submissions._tcp.{{ domain }}      IN  SRV   0 1 465 {{ domain_config.hostname }}.
_submission._tcp.{{ domain }}       IN  SRV   0 1 587 {{ domain_config.hostname }}.
_pop3._tcp.{{ domain }}             IN  SRV   0 1 110 {{ domain_config.hostname }}.
_pop3s._tcp.{{ domain }}            IN  SRV   0 1 995 {{ domain_config.hostname }}.
_autodiscover._tcp.{{ domain }}     IN  SRV   0 1 443 {{ domain_config.hostname }}.

; AUTOCONFIG RECORDS
{{ domain }}                        IN  TXT   "mailconf=https://autoconfig.{{ domain }}/mail/config-v1.1.xml"

; ADDITIONAL NOTES
; ----------------------------------------------------------------------
; This file is for reference only. You will need to add these records to
; your DNS provider's management interface or use automated DNS management
; through the Ansible playbook if configured.
; 
; For advanced setups with DNSSEC validation, ensure that your DNS provider
; supports DNSSEC and enable it for your domain.